{% extends "public.html" %} {% block page %}
<div class="row q-col-gutter-md justify-center">
  <div class="col-12 col-sm-8 col-md-5 col-lg-4">
    <q-card class="q-pa-lg">
      <q-card-section class="q-pa-none">
        <h5 class="text-subtitle1 q-mt-none q-mb-sm">{{ dreidel.memo }}</h5>
        <div v-if="paymentReq" class="q-mt-lg">
          <a class="text-secondary" :href="'lightning:' + paymentReq">
            <q-responsive :ratio="1" class="q-mx-xl q-mb-md">
              <qrcode
                :value="'lightning:' + paymentReq.toUpperCase()"
                :options="{width: 800}"
                class="rounded-borders"
              ></qrcode>
            </q-responsive>
          </a>
          <div class="row q-mt-lg">
            <q-btn outline color="grey" @click="copyText(paymentReq)"
              >Copy invoice</q-btn
            >
            <q-btn @click="cancelPayment" flat color="grey" class="q-ml-auto"
              >Cancel</q-btn
            >
          </div>
        </div>
      </q-card-section>
    </q-card>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  Vue.component(VueQrcode.name, VueQrcode)

  new Vue({
    el: '#vue',
    mixins: [windowMixin],
    data: function () {
      return {
        userAmount: '{{ dreidel.amount }}',
        dreidelAmount: '{{ dreidel.amount }}',
        paymentReq: null,
        paymentDialog: {
          dismissMsg: null,
          checker: null
        }
      }
    },
    computed: {
      amount: function () {
        return this.dreidelAmount > this.userAmount
          ? this.dreidelAmount
          : this.userAmount
      }
    },
    methods: {
      cancelPayment: function () {
        this.paymentReq = null
        clearInterval(this.paymentDialog.checker)
        if (this.paymentDialog.dismissMsg) {
          this.paymentDialog.dismissMsg()
        }
      },
      createInvoice: function () {
        var self = this
        LNbits.api
          .request(
            'POST',
            '/dreidel/api/v1/dreidels/invoice/{{ dreidel.id }}',
            'filler',
            {
              amount: self.amount
            }
          )
          .then(function (response) {
            if (response.data) {
              self.paymentReq = response.data.payment_request.toUpperCase()
              self.paymentDialog.dismissMsg = self.$q.notify({
                timeout: 0,
                message: 'Waiting for payment...'
              })

              self.paymentDialog.checker = setInterval(function () {
                LNbits.api
                  .request(
                    'POST',
                    '/dreidel/api/v1/dreidels/check_invoice/{{ dreidel.id }}',
                    'filler',
                    {payment_hash: response.data.payment_hash}
                  )
                  .then(function (response) {
                    if (response.data) {
                      if (response.data.paid) {
                        self.cancelPayment()
                        self.$q.notify({
                          type: 'positive',
                          message: 'Payment received!',
                          icon: null
                        })
                      }
                    }
                  })
                  .catch(function (error) {
                    LNbits.utils.notifyApiError(error)
                  })
              }, 2000)
            }
          })
          .catch(function (error) {
            LNbits.utils.notifyApiError(error)
          })
      }
    },
  })
</script>
{% endblock %}
